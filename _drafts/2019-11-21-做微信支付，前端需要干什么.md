---
layout:     post
title:      做微信支付，从配置到开发全流程
subtitle:   前端在不同的环境（如APP、微信内置浏览器、小程序）是如何唤起微信支付的
date:       2019-11-21
author:     阿望
header-img: img/2019-11-21/wechat-pay.jpg
catalog: true
tags:
    - 微信
    - 前端
    - 支付
---

之前对微信的接触仅限于网页Auth2.0授权（有空的时候回忆一下授权写个总结），然后微信内部一些简单的JSAPI的调用（悄咪咪地说，小程序盛行时代，我还没有做过小程序），对于微信支付这一块儿，在接到需求的时候，完全懵逼。那能怎么办？干呗。

## 微信支付分类

微信支付根据不同的支付环境、不同的支付方式，一共划分了7种支付产品

    1. 付款码支付：用户打开微信钱包-付款码的界面，商户扫码后提交完成支付。这种就是用户和商户共同配合的支付方式，需用户自行打开付款码界面，商户使用电子设备扫描二维码或条形码来完成支付过程，目测跟前端没多大关系。查看[付款码支付详细文档](https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=5_1){:_blank}

    2. JSAPI支付：用户通过微信扫码、关注公众号等方式进入商家H5页面，并在微信内调用JSSDK完成支付，适用于商户已有H5商城网站，用户通过消息或扫描二维码在微信内打开网页时，可以调用微信支付完成下单购买的流程。说白了就是网页在微信内置浏览器打开唤起微信支付，多数使用这种支付方式的都是配合微信公众号使用。查看[JSAPI支付详细文档](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_1){:_blank}

    3. Native支付：用户打开“微信扫一扫”，扫描商户的二维码后完成支付。查看[Native支付详细文档](https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1){:_blank}

    4. APP支付：商户APP中集成微信SDK，用户点击后跳转到微信内完成支付。商户APP调用微信提供的SDK调用微信支付模块，商户APP会跳转到微信中完成支付，支付完后跳回到商户APP内，最后展示支付结果。目前微信支付支持手机系统有：IOS（苹果）、Android（安卓）和WP（Windows Phone）。查看[APP支付详细文档](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_1){:_blank}

    5. H5支付：用户在微信以外的手机浏览器请求微信支付的场景唤起微信支付，比如手机自带浏览器，或者下载的浏览器软件。主要用于触屏版的手机浏览器请求微信支付的场景，可以方便的从外部浏览器唤起微信支付。它和JSAPI支付的区别就是一个在微信内唤起，一个在微信外唤起。查看[H5支付详细文档](https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_1){:_blank}

    6. 小程序支付：用户在微信小程序中使用微信支付。查看[小程序支付](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_3&index=1){:_blank}

    7. 人脸支付：无需掏出手机, 刷脸完成支付, 适合线下各种场景。这种和付款码支付方式概念差不多。查看[人脸支付](https://pay.weixin.qq.com/wiki/doc/wxfacepay/){:_blank}

这7种标准的微信支付实现方式在微信的官方文档中都写得非常的详细，但是不得不说，微信的文档，真的被很多人吐槽过。

这次我们主要就讲讲其中JSAPI支付、H5支付和小程序支付，由于我们的APP不是纯Android原生代码，所以附带讲一下H5 Plus封装的微信支付方式。

## 我们的环境

我的工程是基于nuxt搭建的，然后有一套轻量安卓的壳，引入了H5 Plus，方便调用原生API，打包APK的时候将工程带进去，是的，你没有看错！APP、H5、小程序，是一套代码。

## 事前准备

接触过微信相关开发的同学应该都知道，微信有一堆的配置，不管干啥。。。建议不清楚流程的同学先去支付官网看看流程：[【微信支付】普通商户接入文档](https://pay.weixin.qq.com/wiki/doc/api/index.html){:_blank}，其实我个人觉得这个模块应该属于产品经理该操心的事儿，但是这并不妨碍有些甩手掌柜管事儿，只能让开发同学来理流程。

#### 支付权限开通

> 首先确保有微信支付商户平台的账号

商户平台是微信支付提供的商户管理系统，你要做支付，怎么能没有收钱的账号呢，是吧？不然我钱支给谁？

> 然后确保有微信公众平台或开放平台的账号

注意：微信公众平台和开放平台的概念不一样的哈，不清楚的先自行百度清楚了再看下去。

没有的，去这里：[微信公众平台](https://mp.weixin.qq.com/cgi-bin/loginpage?url=%2Fcgi-bin%2Fhome){:_blank}  [微信开放平台](https://open.weixin.qq.com/){:_blank}

> 开通权限

支付权限：商户（也就是你）在微信公众平台（注：需要认证的服务号才能申请）或开放平台提交微信支付申请，微信支付工作人员审核资料无误后开通相应的微信支付权限。微信支付申请审核通过后，商户在申请资料填写的邮箱中收取到由微信支付小助手发送的邮件，此邮件包含开发时需要使用的支付账户信息，将商户信息与开放平台关联上。

#### 微信支付参数配置

如果是商家H5页面在微信中打开，然后使用微信支付的话，就需要通过公众号授权的形式来唤起微信支付，比如我的一整套H5代码，我拿到域名了在微信内置浏览器访问，并且需要唤起微信支付，就属于这种情况。

> 设置网页授权回调域名

用户在网页授权页同意授权给公众号后，微信会将授权数据（如openid、用户信息等）传给公众号设置的授权回调域名下的一个回调页面，以确保安全可靠。

进入微信公众平台后台，找到开发者中心，修改网页授权获取用户信息【没有公众号的权限，只能网上找了个不太清晰的图片，将个烂就先看着吧】

具体路径：微信公众平台后台 —> 开发者中心 —> 网页服务 —> 网页授权获取用户信息 —> 修改：将你的授权回调域添加进去，注意：授权回调域名配置规范为全域名并且不带http，回调页面域名不支持IP地址

![image](https://awang0608.github.io/img/2019-11-21/auth-path.png)

![image](https://awang0608.github.io/img/2019-11-21/auth.png)

> 修改微信支付授权目录

商户配置好微信支付授权目录，唤起微信支付的页面必须是在该目录下才能成功，否则，大概率会报“当前页面的url未注册”的错误。

具体路径：微信公众平台后台 —> 微信支付 —> 开发者配置 —> 支付配置 —> 添加：将你的支付授权目录添加进去，注意：支付授权目录应该为支付页面链接的上一级目录，比如访问url为：http://a.com/pay/index，授权目录应为：http://a.com/pay/

![image](https://awang0608.github.io/img/2019-11-21/wechat-pay-auth.jpg)

一啪啦的配置终于是做完了，接下来，终于轮到开发上场了。

#### 微信OAuth2.0网页授权认证

微信公众平台OAuth2.0授权详细步骤如下：

1. 用户关注服务方微信公众账号
2. 服务方提供用户请求授权页面URL
3. 用户点击授权页面URL，将向微信方服务器发起请求
4. 微信方服务器询问用户是否同意授权给微信公众账号(scope为snsapi_base时静默授权，无此步骤，除此外保持7天有效期)
5. 用户同意(scope为snsapi_base时无此步骤)
6. 微信方服务器将CODE通过回调传给服务方微信公众账号
7. 服务方微信公众账号获得CODE
8. 服务方微信公众账号通过CODE向服务器请求Access Token或openid等信息
9. 微信方服务器返回Access Token和OpenID给服务方微信公众账号
10. 服务方微信公众账号通过Access Token向微信方服务器请求用户信息(scope为snsapi_base时无此步骤)
11. 微信方服务器将用户信息回送给服务方微信公众账号(scope为snsapi_base时无此步骤)

基本只做支付的话，授权步骤到第9步，拿到微信支付下单必需的openid参数就可以了。

#### 开发

后端对于微信授权和微信支付的开发主要集中在签名、缓存、获取信息、下单这一块儿，相对于前端来讲，工作量可是大得多。

> APP内唤起微信支付

> 微信内置浏览器唤起微信支付







